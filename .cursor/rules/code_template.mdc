---
alwaysApply: true
---
/**
 * Interactive Recipe Import Tool
 * 
 * Purpose: Add new recipes to Notion with automatic ingredient matching and cost calculation
 * 
 * Usage: node scripts/add-recipe-interactive.js
 * 
 * Features:
 * - Prompts for recipe details
 * - Searches existing Ingredients database
 * - Creates missing ingredients with user-provided costs
 * - Calculates total recipe cost
 * - Links recipe to ingredients
 * - Creates recipe in Notion
 */

const { Client } = require('@notionhq/client');
const readline = require('readline');
require('dotenv').config();

// Initialize Notion client
const notion = new Client({ auth: process.env.NOTION_API_KEY });

// Database IDs from .env
const RECIPES_DB_ID = process.env.NOTION_RECIPES_DB_ID;
const INGREDIENTS_DB_ID = process.env.NOTION_INGREDIENTS_DB_ID;

// Create readline interface for user input
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

/**
 * Prompt user for input
 */
function prompt(question) {
  return new Promise((resolve) => {
    rl.question(question, (answer) => {
      resolve(answer);
    });
  });
}

/**
 * Search for an ingredient in Notion database
 * @param {string} ingredientName - Name to search for
 * @returns {Promise<object|null>} - Ingredient page object or null
 */
async function searchIngredient(ingredientName) {
  try {
    // TODO: Implement Notion database query
    // Filter by title containing ingredientName
    // Return first match or null
    
    const response = await notion.databases.query({
      database_id: INGREDIENTS_DB_ID,
      filter: {
        property: 'Item',
        title: {
          contains: ingredientName
        }
      }
    });
    
    return response.results.length > 0 ? response.results[0] : null;
  } catch (error) {
    console.error('Error searching ingredient:', error.message);
    return null;
  }
}

/**
 * Create a new ingredient in Notion database
 * @param {string} name - Ingredient name
 * @param {number} cost - Ingredient cost
 * @param {string} unit - Unit of measure (optional)
 * @returns {Promise<object>} - Created ingredient page object
 */
async function createIngredient(name, cost, unit = '') {
  try {
    // TODO: Implement Notion page creation
    // Properties: Item (title), Cost (number), Unit (text)
    // Return created page object
    
    const response = await notion.pages.create({
      parent: { database_id: INGREDIENTS_DB_ID },
      properties: {
        'Item': {
          title: [
            {
              text: {
                content: name
              }
            }
          ]
        },
        'Cost': {
          number: cost
        },
        'Unit': {
          rich_text: [
            {
              text: {
                content: unit
              }
            }
          ]
        },
        'Category': {
          select: {
            name: 'Other' // Default category
          }
        }
      }
    });
    
    return response;
  } catch (error) {
    console.error('Error creating ingredient:', error.message);
    throw error;
  }
}

/**
 * Create a recipe in Notion database
 * @param {object} recipeData - Recipe details
 * @returns {Promise<object>} - Created recipe page object
 */
async function createRecipe(recipeData) {
  try {
    // TODO: Implement Notion page creation
    // Properties:
    // - Recipe Name (title)
    // - Category (select)
    // - Cost ($) (number)
    // - Cost per Serving ($) (number)
    // - Servings (number)
    // - Recipe Ingredients (text)
    // - Instructions (text)
    // - Source/Link (url)
    // - Database Ingredients (relation to ingredient pages)
    
    const response = await notion.pages.create({
      parent: { database_id: RECIPES_DB_ID },
      properties: {
        'Recipe Name': {
          title: [
            {
              text: {
                content: recipeData.name
              }
            }
          ]
        },
        'Category': {
          select: {
            name: recipeData.category
          }
        },
        'Cost ($)': {
          number: recipeData.totalCost
        },
        'Cost per Serving ($)': {
          number: recipeData.costPerServing
        },
        'Servings': {
          number: recipeData.servings
        },
        'Recipe Ingredients': {
          rich_text: [
            {
              text: {
                content: recipeData.ingredientsList
              }
            }
          ]
        },
        'Instructions': {
          rich_text: [
            {
              text: {
                content: recipeData.instructions || ''
              }
            }
          ]
        },
        'Source/Link': {
          url: recipeData.sourceUrl || null
        },
        'Database Ingredients ': {
          relation: recipeData.ingredientRelations
        },
        'Tags': {
          multi_select: [
            { name: 'Aldi' }
          ]
        }
      }
    });
    
    return response;
  } catch (error) {
    console.error('Error creating recipe:', error.message);
    throw error;
  }
}

/**
 * Parse ingredient line into quantity, unit, and name
 * @param {string} line - Ingredient line (e.g., "1 lb ground beef")
 * @returns {object} - Parsed ingredient { quantity, unit, name }
 */
function parseIngredientLine(line) {
  // TODO: Implement smart parsing
  // Handle formats like:
  // - "1 lb ground beef"
  // - "2 cups rice"
  // - "1 can black beans"
  // - "ground beef" (no quantity)
  
  const match = line.match(/^(\d+\.?\d*)\s*([a-zA-Z]+)?\s*(.+)$/);
  
  if (match) {
    return {
      quantity: parseFloat(match[1]),
      unit: match[2] || '',
      name: match[3].trim()
    };
  }
  
  return {
    quantity: null,
    unit: '',
    name: line.trim()
  };
}

/**
 * Main interactive flow
 */
async function main() {
  console.log('\nüç≥ Add New Recipe to Notion\n');
  
  try {
    // Step 1: Get recipe details
    const recipeName = await prompt('Recipe name: ');
    const servings = parseInt(await prompt('Servings: '));
    const category = await prompt('Category (Beef/Chicken/Pork/Vegetarian/Seafood/Other): ');
    const sourceUrl = await prompt('Source URL (optional): ');
    
    // Step 2: Get ingredients
    console.log('\nüìù Enter ingredients (one per line, press Enter twice when done):');
    
    const ingredients = [];
    let line = '';
    
    while (true) {
      line = await prompt('> ');
      if (line.trim() === '' && ingredients.length > 0) {
        break;
      }
      if (line.trim() !== '') {
        ingredients.push(line.trim());
      }
    }
    
    // Step 3: Process ingredients
    console.log('\nüîç Processing ingredients...\n');
    
    const ingredientRelations = [];
    const ingredientsList = [];
    let totalCost = 0;
    
    for (const ingredientLine of ingredients) {
      const parsed = parseIngredientLine(ingredientLine);
      ingredientsList.push(ingredientLine);
      
      // Search for ingredient in database
      const existingIngredient = await searchIngredient(parsed.name);
      
      if (existingIngredient) {
        // Found in database
        const cost = existingIngredient.properties.Cost?.number || 0;
        console.log(`‚úÖ Found: ${parsed.name} ($${cost.toFixed(2)})`);
        
        totalCost += cost;
        ingredientRelations.push({ id: existingIngredient.id });
      } else {
        // Not found - prompt for cost
        console.log(`‚ùì Not found: ${parsed.name}`);
        const costInput = await prompt('   Enter cost: $');
        const cost = parseFloat(costInput);
        
        if (!isNaN(cost)) {
          // Create new ingredient
          const newIngredient = await createIngredient(parsed.name, cost, parsed.unit);
          console.log(`‚ú® Created: ${parsed.name} ($${cost.toFixed(2)})`);
          
          totalCost += cost;
          ingredientRelations.push({ id: newIngredient.id });
        }
      }
    }
    
    const costPerServing = totalCost / servings;
    
    console.log('\nüí∞ Cost Summary:');
    console.log(`   Total: $${totalCost.toFixed(2)}`);
    console.log(`   Per Serving: $${costPerServing.toFixed(2)}`);
    
    // Step 4: Get instructions (optional)
    console.log('\nüìñ Instructions (optional, press Enter to skip):');
    const instructions = await prompt('> ');
    
    // Step 5: Confirm and create
    console.log('\n‚ú® Creating recipe in Notion...');
    
    const recipeData = {
      name: recipeName,
      category: category,
      servings: servings,
      totalCost: totalCost,
      costPerServing: costPerServing,
      ingredientsList: ingredientsList.join('\n'),
      instructions: instructions,
      sourceUrl: sourceUrl || null,
      ingredientRelations: ingredientRelations
    };
    
    const createdRecipe = await createRecipe(recipeData);
    
    console.log('\n‚úÖ Recipe added successfully!');
    console.log(`üîó ${createdRecipe.url}`);
    
  } catch (error) {
    console.error('\n‚ùå Error:', error.message);
  } finally {
    rl.close();
  }
}

// Run the script
main();